---
import Layout from "./layouts/Layout.astro";
---

<Layout title="Contact // StarboyChad.com">
  <h1>SECURE COMMS</h1>

  <p>
    Drop a transmission. Collabs, modding requests, questions, or business.
  </p>

  <!-- PRIMARY VISIBLE FORM -->
  <form
    class="contactForm"
    name="contact"
    method="POST"
    action="/contact"
    netlify
    netlify-honeypot="bot-field"
  >
    <!-- REQUIRED FOR NETLIFY -->
    <input type="hidden" name="form-name" value="contact" />

    <!-- HONEYPOT -->
    <p class="hidden">
      <label>
        Don’t fill this out: <input name="bot-field" />
      </label>
    </p>

    <label>
      <span class="label">HANDLE</span>
      <input name="name" type="text" required placeholder="Your name / alias" />
    </label>

    <label>
      <span class="label">REPLY CHANNEL</span>
      <input name="email" type="email" required placeholder="you@domain.com" />
    </label>

    <label>
      <span class="label">MESSAGE</span>
      <textarea
        name="message"
        rows="6"
        required
        placeholder="Type your transmission..."
      ></textarea>
    </label>

    <div class="actions">
      <button type="submit" id="sendBtn">SEND TRANSMISSION</button>
      <span class="note">No popups. Terminal confirmation only.</span>
    </div>
  </form>

  <!-- NETLIFY BUILD-TIME FALLBACK (ASTRO-SAFE) -->
  <form name="contact" netlify hidden>
    <input type="text" name="name" />
    <input type="email" name="email" />
    <textarea name="message"></textarea>
  </form>

  <script>
    const form = document.querySelector("form[name='contact']");

    function log(ts, msg, cls) {
      if (window.NW_LOG?.addLine) window.NW_LOG.addLine(ts, msg, cls);
    }

    async function typeLog(ts, msg, cls) {
      if (window.NW_LOG?.typeLine) return await window.NW_LOG.typeLine(ts, msg, cls);
      log(ts, msg, cls);
    }

    async function pause(ms) {
      if (window.NW_LOG?.sleep) return await window.NW_LOG.sleep(ms);
      return await new Promise((r) => setTimeout(r, ms));
    }

    function lockForm(locked) {
      if (!form) return;

      // Do NOT disable hidden inputs (Netlify needs form-name)
      const fields = form.querySelectorAll(
        "input:not([type='hidden']), textarea, button"
      );
      fields.forEach((el) => (el.disabled = locked));
      form.classList.toggle("locked", locked);
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Capture payload BEFORE locking (disabled fields are excluded)
      const data = new FormData(form);

      lockForm(true);
      await typeLog("00:00:xx", "TRANSMISSION: SENDING…", "cyan");

      try {
        // Netlify expects URL-encoded body for JS submissions
        const params = new URLSearchParams();
        for (const [k, v] of data.entries()) params.append(k, String(v));

        const res = await fetch("/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString(),
        });

        if (!res.ok) throw new Error("Non-OK response");

        await pause(160);
        await typeLog("00:00:xx", "TRANSMISSION: RECEIVED", "ok");
        await pause(160);
        await typeLog("00:00:xx", "ROUTING: TO OPERATOR", "pink");
        await pause(160);
        await typeLog("00:00:xx", "COMMS: CLOSED // REFRESH TO REOPEN", "warn");
      } catch (err) {
        lockForm(false);
        await pause(140);
        await typeLog("00:00:xx", "ERROR: TRANSMISSION FAILED", "err");
        await pause(140);
        await typeLog("00:00:xx", "RETRY OR CHECK CONNECTION", "warn");
      }
    });
  </script>

  <style>
    .contactForm {
      margin-top: 16px;
      display: grid;
      gap: 14px;
      max-width: 720px;
    }

    label { display: grid; gap: 8px; }

    .label {
      font-family: var(--mono);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      font-size: 11px;
      opacity: 0.7;
    }

    input, textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 12px;
      color: rgba(255, 255, 255, 0.92);
      font-family: var(--mono);
      letter-spacing: 0.06em;
      outline: none;
    }

    input:focus, textarea:focus {
      border-color: rgba(34, 211, 238, 0.28);
      box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.16);
    }

    textarea { resize: vertical; }

    .actions {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    button {
      font-family: var(--mono);
      letter-spacing: 0.22em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(34, 211, 238, 0.25);
      background: rgba(34, 211, 238, 0.08);
      color: rgba(255, 255, 255, 0.92);
      cursor: pointer;
      box-shadow: 0 0 18px rgba(34, 211, 238, 0.10);
    }

    button:hover {
      border-color: rgba(232, 121, 249, 0.25);
      background: rgba(232, 121, 249, 0.08);
      box-shadow: 0 0 18px rgba(232, 121, 249, 0.10);
    }

    .note {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      opacity: 0.55;
    }

    .hidden { display: none; }

    .contactForm.locked {
      opacity: 0.7;
      filter: saturate(0.9);
    }

    .contactForm.locked input,
    .contactForm.locked textarea {
      cursor: not-allowed;
    }
  </style>
</Layout>
